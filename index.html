<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The G.O.A.T. Project: 3D Arcade</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js" crossorigin="anonymous"></script>

    <style>
        /*
         * Complete CSS Code for The G.O.A.T. Project (Neon Arcade Theme)
         * Integrated directly from user-provided content.
        */
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&display=swap');

        :root {
            --neon-blue: #00c4ff;
            --neon-pink: #ff00ff;
            --dark-bg: #0a0a1e;
            --dark-section: rgba(10, 10, 30, 0.9);
        }

        /* GLOBAL STYLING */
        body {
            font-family: 'Exo 2', sans-serif;
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column; 
            min-height: 100vh;
            background-color: #000; 
            background-image: linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)), url('https://placehold.co/1920x1080/0d0d0d/ffffff?text=NEON+CITY+SKYLINE');
            background-size: cover;
            background-position: bottom center;
            background-repeat: no-repeat;
            position: relative; /* Needed for positioning the canvas/menu correctly */
        }
        
        /* Loading Overlay Styling */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--neon-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Game Container for Canvas and Scores */
        #game-container {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
            /* Canvas will be appended here */
        }

        /* Canvas Styling (Placeholder, will be styled by Three.js renderer size) */
        canvas {
            display: block;
            border: 3px solid var(--neon-pink);
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.5);
            background-color: #1a1a1a; 
            max-width: 100%;
        }

        /* HUD OVERLAY */
        #hud-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            pointer-events: none; /* Allows clicks to pass to canvas/game */
        }
        .hud-item {
            background: rgba(10, 10, 30, 0.7);
            padding: 5px 15px;
            border-radius: 5px;
            border: 1px solid var(--neon-blue);
            font-size: 1.1em;
            text-shadow: 0 0 5px var(--neon-blue);
            pointer-events: auto; /* Re-enable pointer events for the buttons/info */
        }

        /* --- MENU/SUB-SCREEN STYLING (The rest of the user-provided CSS) --- */
        .missions-log-container,
        .my-player-container,
        .options-container,
        .quit-container,
        .mission-screen,
        .quick-play-game-screen { /* Added quick-play-game-screen for the pause menu functionality */
            background: var(--dark-section);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 196, 255, 0.3);
            width: 90%; 
            max-width: 450px; 
            text-align: center;
            border: 1px solid var(--neon-blue);
            min-height: 400px; 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50; 
            display: none; /* Hidden by default */
        }
        
        .main-menu-container {
            /* Special styling for the main menu to cover the whole screen */
            width: 100%;
            height: 100vh;
            max-width: none;
            padding: 0;
            border: none;
            background: none;
            box-shadow: none;
            display: none; /* Hidden until loaded */
            flex-direction: column;
            justify-content: space-between; 
            align-items: center; 
            position: fixed; /* Fix to viewport */
            top: 0;
            left: 0;
            z-index: 40;
        }

        /* Show initial screen */
        .show { display: flex !important; }
        .hidden { display: none !important; }

        /* ... [All other CSS rules from the previous response] ... */
        .main-menu-container .main-title {
            font-size: 5em;
            color: var(--neon-blue); 
            text-shadow: 0 0 15px rgba(0, 196, 255, 0.8), 0 0 5px rgba(0, 196, 255, 0.5);
            letter-spacing: 2px;
            margin-top: 50px;
            text-align: center;
            line-height: 1;
        }

        @media (max-width: 600px) {
            .main-menu-container .main-title {
                font-size: 3em;
                margin-top: 20px;
            }
        }

        .menu-bar {
            display: flex;
            justify-content: center;
            width: 100%;
            padding: 20px 0;
            background: var(--dark-section);
            border-top: 1px solid var(--neon-blue);
            box-shadow: 0 0 30px rgba(0, 196, 255, 0.3);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 60;
        }

        @media (max-width: 600px) {
            .menu-bar {
                flex-wrap: wrap; 
                padding: 10px 0;
                gap: 5px;
            }
        }

        .main-menu-container .menu-button {
            width: 180px; 
            text-align: center;
            margin: 0 10px; 
            padding: 15px 30px;
            font-size: 1.2em;
        }

        @media (max-width: 600px) {
            .main-menu-container .menu-button {
                width: 45%;
                margin: 5px;
                padding: 10px 15px;
                font-size: 1em;
            }
        }


        .missions-log-container h2, 
        .my-player-container h2, 
        .options-container h2,
        .mission-screen h2 {
            font-size: 2em;
            border-bottom: 2px solid var(--neon-pink); 
            padding-bottom: 10px;
            margin-bottom: 30px;
            letter-spacing: 1px;
            color: var(--neon-pink);
        }

        .menu-button, .neon-btn {
            background-color: rgba(30, 30, 70, 0.8); 
            color: var(--neon-blue);
            border: 1px solid var(--neon-blue); 
            padding: 15px 30px;
            margin: 10px 0;
            cursor: pointer;
            font-size: 1.2em;
            border-radius: 5px;
            transition: all 0.2s ease;
            width: 100%; 
            text-align: left;
        }

        .menu-button:hover, .neon-btn:hover {
            background-color: var(--neon-blue); 
            color: var(--dark-bg); 
            box-shadow: 0 0 20px rgba(0, 196, 255, 0.5);
        }

        .neon-btn {
            width: auto;
            text-align: center;
            padding: 10px 20px;
        }

        .mission-item, .contract-button {
            background-color: rgba(30, 30, 70, 0.8);
            color: white;
            border: 1px solid var(--neon-pink);
            padding: 12px 20px;
            margin: 8px 0;
            cursor: pointer;
            font-size: 1em;
            border-radius: 5px;
            transition: all 0.2s ease;
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mission-item span:first-child { flex-grow: 1; }
        .mission-item span:last-child { color: var(--neon-blue); font-weight: bold; }

        .mission-item:hover, .contract-button:hover {
            background-color: rgba(255, 0, 255, 0.2);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.6);
        }

        .my-player-container p {
            text-align: left;
            margin: 10px 0;
            font-size: 1.1em;
        }

        .progress-bar-container {
            width: 100%;
            height: 15px;
            background-color: #222;
            border: 1px solid var(--neon-blue);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden; 
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--neon-pink);
            transition: width 0.5s ease-in-out;
        }
        
        #user-id-display {
            font-size: 0.8em;
            color: rgba(0, 196, 255, 0.5);
            margin-top: 10px;
            word-wrap: break-word;
            text-align: center;
            position: absolute;
            top: 5px;
            right: 10px;
            max-width: 100px;
            z-index: 50;
        }

        /* MISSION 1 & QUICK PLAY: Skill Button */
        .skill-button {
            background-color: var(--neon-pink);
            color: var(--dark-bg);
            border: none;
            padding: 20px 40px;
            cursor: pointer;
            font-size: 1.5em;
            font-weight: bold;
            border-radius: 5px;
            transition: all 0.2s ease;
            text-transform: uppercase;
        }

        .skill-button:hover {
            background-color: var(--neon-blue);
            color: var(--dark-bg);
            box-shadow: 0 0 20px rgba(0, 196, 255, 0.5);
        }

        /* Custom Modal Styling */
        #message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #message-box {
            background: var(--dark-section);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 40px rgba(255, 0, 255, 0.7);
            border: 2px solid var(--neon-pink);
            text-align: center;
            max-width: 350px;
            animation: pulse 0.8s ease-in-out infinite alternate;
        }

        .modal-text {
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        @keyframes pulse {
            from { box-shadow: 0 0 20px rgba(255, 0, 255, 0.5); }
            to { box-shadow: 0 0 40px rgba(255, 0, 255, 0.7); }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <h3 id="loading-status">Connecting to the Grid...</h3>
    </div>

    <div id="hud-overlay" class="hidden">
        <div id="score-display" class="hud-item">SCORE: 0</div>
        <div id="shots-fired" class="hud-item">SHOTS: 0</div>
        <div id="high-score-display" class="hud-item">BEST: 0</div>
    </div>
    
    <div id="game-container">
        </div>

    <div id="main-menu" class="main-menu-container">
        <h1 class="main-title">THE G.O.A.T. PROJECT</h1>
        <div id="user-info" class="hud-item" style="position: absolute; top: 10px; right: 10px; z-index: 70;">User: Connecting...</div>
        <div class="menu-bar">
            <button class="menu-button" onclick="showScreen('my-hub-screen')"><i class="fas fa-user-tie"></i> MY HUB</button>
            <button class="menu-button" onclick="showScreen('missions-screen')"><i class="fas fa-list-check"></i> MISSIONS</button>
            <button class="menu-button" onclick="quickPlay()"><i class="fas fa-running"></i> QUICK PLAY</button>
            <button class="menu-button" onclick="showScreen('options-screen')"><i class="fas fa-sliders"></i> OPTIONS</button>
            <button class="menu-button" onclick="showModal('System Shutdown', 'This feature is not implemented yet.')"><i class="fas fa-right-from-bracket"></i> QUIT</button>
        </div>
    </div>

    <div id="my-hub-screen" class="my-player-container hidden">
        <h2>MY HUB</h2>
        <p><strong>Overall Rating:</strong> <span id="stats-overall-rating">75</span></p>
        <p><strong>High Score:</strong> <span id="stats-high-score">0</span></p>
        <div class="progress-bar-container"><div id="mission-progress-bar" class="progress-bar"></div></div>
        <button class="neon-btn" onclick="showScreen('main-menu')">BACK TO MAIN MENU</button>
    </div>

    <div id="missions-screen" class="missions-log-container hidden">
        <h2>MISSIONS LOG</h2>
        <div id="mission-list">
            <button class="mission-item" onclick="startMission(1)">
                <span>1. The Meter Challenge</span>
                <span><i class="fas fa-lock-open"></i></span>
            </button>
            <button id="mission-2-button" class="mission-item" onclick="startMission(2)">
                <span>2. The Rookie Contract (LOCKED)</span>
                <span><i class="fas fa-lock"></i></span>
            </button>
        </div>
        <button class="neon-btn" onclick="showScreen('main-menu')">RETURN</button>
    </div>

    <div id="mission-1-screen" class="mission-screen hidden">
        <h2>Mission 1: The Meter Challenge</h2>
        <p>Tap the meter as close to 85% as possible to complete the mission.</p>
        <div id="meter-display">--</div>
        <div id="meter-container" style="position: relative; width: 100%; height: 20px; background: #333; border: 1px solid var(--neon-blue); border-radius: 5px; margin-bottom: 20px;">
            <div id="meter-target" style="position: absolute; left: 80%; width: 10%; height: 100%; background: rgba(0, 196, 255, 0.5); border-left: 1px solid var(--neon-blue);"></div>
            <div id="meter-pointer" style="position: absolute; left: 0; width: 5px; height: 100%; background: var(--neon-pink); box-shadow: 0 0 5px var(--neon-pink);"></div>
        </div>
        <button class="skill-button" onclick="stopMeter()">STOP METER</button>
        <p id="mission-feedback" style="margin-top: 20px; font-weight: bold;"></p>
        <button class="neon-btn" style="margin-top: 20px;" onclick="showScreen('missions-screen')">BACK</button>
    </div>

    <div id="message-modal" class="hidden">
        <div id="message-box">
            <h3 id="modal-title" style="color: var(--neon-pink);"></h3>
            <p id="modal-text" class="modal-text"></p>
            <button id="modal-ok-btn" class="neon-btn" onclick="hideModal()">OKAY</button>
        </div>
    </div>


    <script type="module">
        // --- LIBRARY IMPORTS ---
        // Firebase (Auth, Firestore)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Three.js (3D Rendering)
        import * as THREE from 'https://unpkg.com/three@0.137.0/build/three.module.js';
        
        // Cannon.js (Physics)
        import * as CANNON from 'https://cdn.jsdelivr.net/npm/cannon-es@0.19.0/dist/cannon-es.js';

        // --- GLOBAL CONFIGURATION (MOCK PLATFORM VARIABLES) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'arcade-default-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: 'MOCK_API_KEY', authDomain: 'mock-domain.firebaseapp.com', projectId: 'mock-project' };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- GAME STATE ---
        let app, db, auth;
        let userId = null;
        let gameInitialized = false;

        // Player Data State (Local)
        let playerData = {
            overallRating: 75,
            highScore: 0,
            currentMission: 1, 
            missions: {
                1: { completed: false, ratingBonus: 5 },
                2: { completed: false, ratingBonus: 0 }
            },
        };
        const USER_DATA_PATH = (uid) => `artifacts/${appId}/users/${uid}/gameData/playerProfile`;

        // --- 3D & PHYSICS STATE ---
        let scene, camera, renderer, world;
        let playerBody, basketballBody, basketballMesh;
        let inputState = { forward: false, backward: false, left: false, right: false, shoot: false };
        let canShoot = true;
        let score = 0;
        let shotsFired = 0;
        let clock = new THREE.Clock();

        const PLAYER_SPEED = 5;
        const SHOT_FORCE = 15;
        const PLAYER_MASS = 50;


        // --- UI & SCREEN MANAGEMENT ---

        const SCREEN_IDS = ['main-menu', 'my-hub-screen', 'missions-screen', 'options-screen', 'mission-1-screen', 'mission-2-screen'];

        window.showScreen = (screenId) => {
            // Hide all sub-screens
            SCREEN_IDS.forEach(id => {
                const screen = document.getElementById(id);
                if (screen) screen.classList.add('hidden');
            });

            // Show the requested screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) targetScreen.classList.remove('hidden');

            // Toggle HUD visibility and 3D loop based on whether a main menu is showing
            const isMenuOpen = (screenId !== 'quick-play-game-screen');
            document.getElementById('hud-overlay').classList.toggle('hidden', isMenuOpen);
            
            // Special case for Quick Play to re-engage the loop
            if (screenId === 'quick-play-game-screen') {
                document.getElementById('game-container').classList.remove('hidden');
                document.getElementById('hud-overlay').classList.remove('hidden');
                // The game loop (animate) continues running but physics steps only when playing
            } else if (screenId === 'main-menu') {
                // Ensure the canvas is not covered by any screen other than the main menu bar
                document.getElementById('game-container').classList.remove('hidden');
            }
            
            // If exiting a mission, update UI
            if (screenId === 'missions-screen') updateMissionUI();
            if (screenId === 'my-hub-screen') updateHubUI();
        };

        window.quickPlay = () => {
            // Start the 3D loop if it's not running
            if (!gameInitialized) init3DEnvironment(); 

            // The 3D environment is now the main view
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            document.getElementById('hud-overlay').classList.remove('hidden');
            
            resetGame(false);
        };

        window.showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
            
            // Stop the pulsing animation after a short delay
            document.getElementById('message-box').style.animation = 'pulse 0.8s ease-in-out infinite alternate';
        };

        window.hideModal = () => {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-box').style.animation = 'none';
        };


        // --- FIREBASE & DATA LOGIC ---

        async function initFirebase() {
            document.getElementById('loading-status').textContent = "Connecting to the Grid...";

            try {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === 'MOCK_API_KEY') {
                    throw new Error("Missing or mock Firebase configuration. Playing offline.");
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await setPersistence(auth, browserLocalPersistence);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                const user = auth.currentUser;
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-info').textContent = `Agent: ${userId.substring(0, 8)}...`;
                    initFirestoreListener();
                } else {
                    throw new Error("Authentication failed to return a user.");
                }

            } catch (error) {
                console.error("Firebase Init Failed:", error);
                document.getElementById('loading-status').textContent = "Connection Failed. Playing Offline.";
                userId = 'GUEST-' + crypto.randomUUID().substring(0, 8);
                document.getElementById('user-info').textContent = `GUEST: ${userId}`;
                // Since offline, we just use the default playerData
                updateHubUI();
                updateMissionUI();
                init3DEnvironment(); // Start the 3D environment regardless
                hideLoading();
            }
        }

        function initFirestoreListener() {
            if (!db || !userId) return;

            const userDocRef = doc(db, USER_DATA_PATH(userId));

            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const fetchedData = docSnap.data();
                    
                    playerData.overallRating = fetchedData.overallRating || 75;
                    playerData.highScore = fetchedData.highScore || 0;
                    playerData.currentMission = fetchedData.currentMission || 1;
                    
                    // Safely parse missions data
                    try {
                        playerData.missions = JSON.parse(fetchedData.missions) || playerData.missions;
                    } catch (e) {
                        playerData.missions = fetchedData.missions || playerData.missions;
                    }
                    console.log("Player data updated from Firestore:", playerData);
                } else {
                    console.log("No profile found, creating new one.");
                    savePlayerData(); // Create initial document
                }

                updateScoreDisplays();
                updateHubUI();
                updateMissionUI();
                
                if (!gameInitialized) {
                    init3DEnvironment();
                    hideLoading();
                }
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                showModal('Lost Connection', 'Lost connection to game server. Data may not save.');
            });
        }

        async function savePlayerData() {
            if (!db || !userId) return;
            const userDocRef = doc(db, USER_DATA_PATH(userId));
            const dataToSave = {
                overallRating: playerData.overallRating,
                highScore: playerData.highScore,
                currentMission: playerData.currentMission,
                missions: JSON.stringify(playerData.missions),
                updatedAt: new Date().toISOString()
            };
            try {
                await setDoc(userDocRef, dataToSave, { merge: true });
            } catch (error) {
                console.error("Error saving player data:", error);
                showModal('Save Error', 'Could not save your progress.');
            }
        }
        
        function updateScoreDisplays() {
            document.getElementById('score-display').textContent = `SCORE: ${score}`;
            document.getElementById('shots-fired').textContent = `SHOTS: ${shotsFired}`;
            document.getElementById('high-score-display').textContent = `BEST: ${playerData.highScore}`;
        }
        
        function updateHubUI() {
            document.getElementById('stats-overall-rating').textContent = playerData.overallRating;
            document.getElementById('stats-high-score').textContent = playerData.highScore;
            
            // Progress bar (simple linear based on current mission)
            const progress = (playerData.currentMission - 1) * 50; 
            document.getElementById('mission-progress-bar').style.width = `${Math.min(100, progress)}%`;
        }

        function updateMissionUI() {
            const m2 = document.getElementById('mission-2-button');
            if (!m2) return;

            if (playerData.currentMission > 1) {
                m2.innerHTML = `<span>2. The Rookie Contract</span><span><i class="fas fa-lock-open"></i> READY</span>`;
                m2.disabled = false;
            } else {
                m2.innerHTML = `<span>2. The Rookie Contract (LOCKED)</span><span><i class="fas fa-lock"></i></span>`;
                m2.disabled = true;
            }
        }


        // --- 3D & PHYSICS INITIALIZATION ---

        function init3DEnvironment() {
            // --- THREE.JS SETUP ---
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x333333); 
            renderer.shadowMap.enabled = true;
            renderer.domElement.id = 'game-canvas'; // Ensure the canvas has the ID we use in CSS
            document.getElementById('game-container').appendChild(renderer.domElement);

            // --- CANNON.JS SETUP ---
            world = new CANNON.World();
            world.gravity.set(0, -9.82, 0);
            world.broadphase = new CANNON.NaiveBroadphase();
            world.solver.iterations = 10;
            
            // --- SCENE ELEMENTS ---
            createLights();
            createGround();
            createHoopStructure(0, 3.0, -10);
            createPlayer(0, 0.5, 5);
            createBall();

            // --- CAMERA ---
            camera.position.set(0, 3, 10); 
            
            // --- EVENT LISTENERS ---
            window.addEventListener('resize', onWindowResize, false);
            document.addEventListener('keydown', onKeyDown, false);
            document.addEventListener('keyup', onKeyUp, false);
            
            gameInitialized = true;
            animate();
            
            // Show the main menu first
            showScreen('main-menu');
        }

        function createLights() {
            scene.add(new THREE.AmbientLight(0x404040, 10));
            const spotLight = new THREE.SpotLight(0xffffff, 200, 100, Math.PI * 0.25, 0.5, 2);
            spotLight.position.set(0, 20, 0);
            spotLight.castShadow = true;
            scene.add(spotLight);
        }

        function createGround() {
            const groundShape = new CANNON.Plane();
            const groundBody = new CANNON.Body({ mass: 0, shape: groundShape });
            groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
            world.addBody(groundBody);

            const groundMesh = new THREE.Mesh(
                new THREE.PlaneGeometry(100, 100),
                new THREE.MeshStandardMaterial({ color: 0x228B22, side: THREE.DoubleSide })
            );
            groundMesh.rotation.x = -Math.PI / 2;
            groundMesh.receiveShadow = true;
            scene.add(groundMesh);
        }

        function createHoopStructure(x, y, z) {
            // Backboard (Mesh & Physics)
            const backboardGeo = new THREE.BoxGeometry(2, 1.5, 0.1);
            const backboardMat = new THREE.MeshStandardMaterial({ color: 0xff00ff, metalness: 0.8, roughness: 0.2 });
            const backboardMesh = new THREE.Mesh(backboardGeo, backboardMat);
            backboardMesh.position.set(x, y, z);
            backboardMesh.castShadow = true;
            scene.add(backboardMesh);

            const backboardShape = new CANNON.Box(new CANNON.Vec3(1, 0.75, 0.05));
            const backboardBody = new CANNON.Body({ mass: 0, shape: backboardShape, position: new CANNON.Vec3(x, y, z) });
            world.addBody(backboardBody);

            // Rim (Mesh & Physics)
            const rimGeo = new THREE.TorusGeometry(0.4, 0.05, 8, 32);
            const rimMat = new THREE.MeshStandardMaterial({ color: 0xff4500 });
            const rimMesh = new THREE.Mesh(rimGeo, rimMat);
            rimMesh.rotation.x = Math.PI / 2;
            rimMesh.position.set(x, y - 0.5, z + 0.5);
            scene.add(rimMesh);

            const rimShape = new CANNON.Cylinder(0.4, 0.4, 0.1, 16);
            const rimBody = new CANNON.Body({ mass: 0, shape: rimShape, position: new CANNON.Vec3(x, y - 0.5, z + 0.5) });
            rimBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
            world.addBody(rimBody);
            
            // Score sensor
            const sensorShape = new CANNON.Box(new CANNON.Vec3(0.5, 0.01, 0.5));
            const sensorBody = new CANNON.Body({ mass: 0, shape: sensorShape, position: new CANNON.Vec3(x, y - 0.6, z + 0.5) });
            sensorBody.collisionResponse = false; 
            world.addBody(sensorBody);

            sensorBody.addEventListener('collide', (event) => {
                if (event.body === basketballBody) {
                    handleScore();
                }
            });
        }

        function createPlayer(x, y, z) {
            const playerShape = new CANNON.Sphere(0.5);
            playerBody = new CANNON.Body({ mass: PLAYER_MASS, shape: playerShape, position: new CANNON.Vec3(x, y, z) });
            playerBody.linearDamping = 0.9;
            playerBody.angularDamping = 0.9;
            world.addBody(playerBody);

            const playerMesh = new THREE.Mesh(
                new THREE.SphereGeometry(0.5, 16, 16),
                new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true, transparent: true, opacity: 0.3 })
            );
            scene.add(playerMesh);
            playerBody.userData = { mesh: playerMesh }; // Link mesh to body
        }

        function createBall() {
            const ballRadius = 0.25;
            const ballGeo = new THREE.SphereGeometry(ballRadius, 32, 32);
            const ballMat = new THREE.MeshStandardMaterial({ color: 0xff8c00, roughness: 0.6, metalness: 0.1 });
            basketballMesh = new THREE.Mesh(ballGeo, ballMat);
            basketballMesh.castShadow = true;
            scene.add(basketballMesh);

            const ballShape = new CANNON.Sphere(ballRadius);
            basketballBody = new CANNON.Body({ 
                mass: 1, 
                shape: ballShape, 
                position: new CANNON.Vec3(0, 1, 5),
                material: new CANNON.Material("ballMaterial")
            });
            basketballBody.linearDamping = 0.1;
            basketballBody.angularDamping = 0.5;
            world.addBody(basketballBody);
        }
        
        // --- GAME LOGIC ---

        function handleScore() {
            if (basketballBody.velocity.y < -0.5) {
                if (!basketballBody.userData || !basketballBody.userData.scored) {
                    score += 2;
                    basketballBody.userData = { scored: true }; 
                    updateScoreDisplays();
                    showModal('SWISH!', '+2 Points Added to Score!');
                    
                    if (score > playerData.highScore) {
                        playerData.highScore = score;
                        savePlayerData();
                    }
                }
            }
        }
        
        function shootBall() {
            if (!canShoot || !playerBody || !basketballBody) return;
            canShoot = false;
            
            shotsFired++;
            updateScoreDisplays();

            basketballBody.userData = { scored: false }; 

            const playerPos = playerBody.position;
            const hoopPos = new CANNON.Vec3(0, 3.0, -10); 
            
            let direction = new CANNON.Vec3();
            hoopPos.vsub(playerPos, direction);
            direction.normalize();
            
            // Add a vertical component for the arc
            const shotDirection = new CANNON.Vec3(direction.x, direction.y + 0.5, direction.z);
            shotDirection.normalize();

            // Ball initial position
            const ballInitialPos = new CANNON.Vec3(
                playerPos.x + shotDirection.x * 0.5,
                playerPos.y + 1.5,
                playerPos.z + shotDirection.z * 0.5
            );

            // Reset ball state and position
            basketballBody.velocity.set(0, 0, 0);
            basketballBody.angularVelocity.set(0, 0, 0);
            basketballBody.position.copy(ballInitialPos);
            
            // Apply impulse (force) scaled by player rating
            basketballBody.applyImpulse(
                shotDirection.scale(SHOT_FORCE + (playerData.overallRating / 20)),
                basketballBody.position
            );
            
            // Cooldown
            setTimeout(() => { canShoot = true; }, 1500);
        }

        function resetBallPosition() {
            if (!basketballBody || !playerBody) return;
            basketballBody.velocity.set(0, 0, 0);
            basketballBody.angularVelocity.set(0, 0, 0);
            basketballBody.position.set(playerBody.position.x, playerBody.position.y + 1, playerBody.position.z);
            basketballBody.userData = { scored: false };
            canShoot = true;
        }

        function resetGame(shouldSave) {
            if (shouldSave && score > playerData.highScore) {
                playerData.highScore = score;
                savePlayerData();
            }

            score = 0;
            shotsFired = 0;
            updateScoreDisplays();
            
            if (playerBody) {
                playerBody.position.set(0, 0.5, 5); 
                playerBody.velocity.set(0, 0, 0);
                playerBody.angularVelocity.set(0, 0, 0);
            }
            resetBallPosition();
        }

        // --- GAME LOOP ---

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            // Only run physics if not in a menu (i.e., quick-play is active)
            const isPlaying = !document.getElementById('hud-overlay').classList.contains('hidden');

            if (isPlaying) {
                // --- PHYSICS STEP ---
                world.step(1/60, delta, 3);
                
                // --- PLAYER MOVEMENT (Input) ---
                if (playerBody) {
                    let moveVector = new THREE.Vector3(0, 0, 0);
                    if (inputState.forward) moveVector.z -= 1;
                    if (inputState.backward) moveVector.z += 1;
                    if (inputState.left) moveVector.x -= 1;
                    if (inputState.right) moveVector.x += 1;
                    moveVector.normalize();
                    
                    let desiredVelocity = new CANNON.Vec3(
                        moveVector.x * PLAYER_SPEED,
                        playerBody.velocity.y,
                        moveVector.z * PLAYER_SPEED
                    );
                    
                    let currentVel = playerBody.velocity;
                    let force = new CANNON.Vec3();
                    desiredVelocity.vsub(currentVel, force);
                    force.scale(playerBody.mass * 10, force);

                    playerBody.velocity.x *= 0.8;
                    playerBody.velocity.z *= 0.8;
                    playerBody.applyForce(force, playerBody.position);
                    
                    // Update Player Mesh
                    playerBody.userData.mesh.position.copy(playerBody.position);
                    playerBody.userData.mesh.quaternion.copy(playerBody.quaternion);
                }
                
                // Update Basketball Mesh
                if (basketballMesh && basketballBody) {
                    basketballMesh.position.copy(basketballBody.position);
                    basketballMesh.quaternion.copy(basketballBody.quaternion);
                    
                    // Check if ball is too far
                    if (basketballBody.position.length() > 50) {
                        resetBallPosition();
                    }
                }
                
                // Update Camera
                if (camera && playerBody) {
                    camera.position.x = playerBody.position.x;
                    camera.position.z = playerBody.position.z + 5;
                    camera.position.y = playerBody.position.y + 3;
                    camera.lookAt(0, 2.5, -10); 
                }
            }

            // Always render, even if physics is paused (for menu screens)
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }
        
        // --- EVENT HANDLERS ---
        function onWindowResize() {
            if (camera && renderer) {
                camera.aspect = window.innerWidth
